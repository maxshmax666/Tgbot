<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pizza Tagil Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        --bg: #0f1115;
        --panel: #171a21;
        --panel-soft: #1f2430;
        --accent: #ff7a1a;
        --text: #f5f5f5;
        --muted: #9aa3b2;
        --border: #2d313a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px 16px 40px;
        background: var(--bg);
        color: var(--text);
      }
      main {
        max-width: 520px;
        margin: 0 auto;
      }
      h1 {
        margin: 0 0 16px;
        font-size: 24px;
        font-weight: 700;
      }
      .tabs {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 18px;
      }
      .tab-button {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--panel-soft);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
      }
      .tab-button.active {
        background: var(--accent);
        color: #0b0b0b;
        border-color: transparent;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      .menu-grid {
        display: grid;
        gap: 14px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        display: grid;
        gap: 12px;
      }
      .card-header {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 12px;
        align-items: center;
      }
      .card img {
        width: 96px;
        height: 96px;
        border-radius: 14px;
        object-fit: cover;
        border: 1px solid var(--border);
        cursor: pointer;
      }
      .card-title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .card-title h3 {
        margin: 0;
        font-size: 18px;
      }
      .price {
        font-weight: 600;
        color: var(--accent);
      }
      .qty-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .qty-controls button {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel-soft);
        color: var(--text);
        font-weight: 700;
        cursor: pointer;
      }
      .qty-controls span {
        min-width: 24px;
        text-align: center;
        font-weight: 600;
      }
      .helper {
        color: var(--muted);
        font-size: 13px;
      }
      .cart-list {
        display: grid;
        gap: 12px;
        margin-bottom: 16px;
      }
      .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        background: var(--panel);
        border: 1px solid var(--border);
      }
      .cart-item strong {
        display: block;
      }
      .cart-total {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 12px;
        border-radius: 12px;
        background: var(--panel-soft);
        border: 1px dashed var(--border);
        font-weight: 600;
      }
      .cta {
        margin-top: 16px;
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: none;
        background: var(--accent);
        color: #0b0b0b;
        font-weight: 600;
        cursor: pointer;
      }
      .cta.secondary {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .account-panel {
        padding: 16px;
        background: var(--panel);
        border-radius: 16px;
        border: 1px solid var(--border);
      }
      .empty {
        padding: 16px;
        border: 1px dashed var(--border);
        border-radius: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Pizza Tagil Mini App</h1>
      <div class="tabs" role="tablist">
        <button class="tab-button active" type="button" data-tab="menu" role="tab" aria-selected="true">
          Меню
        </button>
        <button class="tab-button" type="button" data-tab="cart" role="tab" aria-selected="false">
          Корзина
        </button>
        <button class="tab-button" type="button" data-tab="account" role="tab" aria-selected="false">
          Аккаунт
        </button>
      </div>

      <section id="tab-menu" class="tab-panel active" role="tabpanel">
        <div class="menu-grid" id="menuGrid"></div>
      </section>

      <section id="tab-cart" class="tab-panel" role="tabpanel">
        <div class="cart-list" id="cartList"></div>
        <div class="cart-total" id="cartTotal">
          <span>Итого</span>
          <span>0 ₽</span>
        </div>
        <button class="cta secondary" type="button" id="clearCart">Очистить корзину</button>
      </section>

      <section id="tab-account" class="tab-panel" role="tabpanel">
        <div class="account-panel">
          <h3>Аккаунт</h3>
          <p class="helper">Раздел в разработке. Здесь будут адреса, история заказов и избранное.</p>
        </div>
      </section>
    </main>

    <script>
      const pizzas = [
        {
          id: "margarita",
          title: "Маргарита",
          price: 520,
          images: [
            "../margarita/margarita_01.jpg",
            "../margarita/margarita_07.jpg",
            "../margarita/margarita_13.jpg",
          ],
        },
        {
          id: "four-cheese",
          title: "4 сыра",
          price: 640,
          images: [
            "../4chees/4cheese_01.jpg",
            "../4chees/4cheese_08.jpg",
            "../4chees/4cheese_13.jpg",
          ],
        },
        {
          id: "meat",
          title: "Мясная",
          price: 690,
          images: [
            "../myasnaya/myasnaya_01.jpg",
            "../myasnaya/myasnaya_08.jpg",
            "../myasnaya/myasnaya_15.jpg",
          ],
        },
        {
          id: "kolbasa",
          title: "Колбасная",
          price: 610,
          images: [
            "../kolbasa/IMG_20251219_230306432.jpg",
            "../kolbasa/IMG_20251223_210236925.jpg",
            "../kolbasa/IMG_20260110_183311633.jpg",
          ],
        },
      ];

      const storageKey = "pizza_cart_v1";
      const cart = loadCart();

      const menuGrid = document.getElementById("menuGrid");
      const cartList = document.getElementById("cartList");
      const cartTotal = document.getElementById("cartTotal");
      const clearCartButton = document.getElementById("clearCart");

      function loadCart() {
        try {
          const raw = window.localStorage.getItem(storageKey);
          if (!raw) return {};
          const data = JSON.parse(raw);
          return typeof data === "object" && data ? data : {};
        } catch (error) {
          console.warn("Не удалось прочитать корзину", error);
          return {};
        }
      }

      function saveCart() {
        try {
          window.localStorage.setItem(storageKey, JSON.stringify(cart));
        } catch (error) {
          console.warn("Не удалось сохранить корзину", error);
        }
      }

      function setQty(id, value) {
        if (value <= 0) {
          delete cart[id];
        } else {
          cart[id] = value;
        }
        saveCart();
        renderMenu();
        renderCart();
      }

      function getQty(id) {
        return cart[id] || 0;
      }

      function renderMenu() {
        menuGrid.innerHTML = "";
        pizzas.forEach((pizza) => {
          const card = document.createElement("div");
          card.className = "card";

          const header = document.createElement("div");
          header.className = "card-header";

          const img = document.createElement("img");
          img.src = pizza.images[0];
          img.alt = pizza.title;
          img.dataset.index = "0";
          img.addEventListener("click", () => {
            const current = Number(img.dataset.index || 0);
            const nextIndex = (current + 1) % pizza.images.length;
            img.dataset.index = String(nextIndex);
            img.src = pizza.images[nextIndex];
          });

          const title = document.createElement("div");
          title.className = "card-title";
          title.innerHTML = `<h3>${pizza.title}</h3><span class="price">${pizza.price} ₽</span>`;

          header.append(img, title);

          const controls = document.createElement("div");
          controls.className = "qty-controls";

          const minus = document.createElement("button");
          minus.type = "button";
          minus.textContent = "-";
          minus.setAttribute("aria-label", `Уменьшить ${pizza.title}`);
          minus.addEventListener("click", () => setQty(pizza.id, getQty(pizza.id) - 1));

          const qty = document.createElement("span");
          qty.textContent = getQty(pizza.id);

          const plus = document.createElement("button");
          plus.type = "button";
          plus.textContent = "+";
          plus.setAttribute("aria-label", `Увеличить ${pizza.title}`);
          plus.addEventListener("click", () => setQty(pizza.id, getQty(pizza.id) + 1));

          controls.append(minus, qty, plus);

          const helper = document.createElement("div");
          helper.className = "helper";
          helper.textContent = "Нажмите на фото, чтобы пролистать галерею";

          card.append(header, controls, helper);
          menuGrid.append(card);
        });
      }

      function renderCart() {
        cartList.innerHTML = "";
        const items = pizzas.filter((pizza) => getQty(pizza.id) > 0);

        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "Корзина пуста. Выберите пиццу в меню.";
          cartList.append(empty);
        } else {
          items.forEach((pizza) => {
            const row = document.createElement("div");
            row.className = "cart-item";

            const info = document.createElement("div");
            info.innerHTML = `<strong>${pizza.title}</strong><span class="helper">${getQty(
              pizza.id,
            )} × ${pizza.price} ₽</span>`;

            const total = document.createElement("div");
            total.textContent = `${getQty(pizza.id) * pizza.price} ₽`;

            row.append(info, total);
            cartList.append(row);
          });
        }

        const totalValue = items.reduce((sum, pizza) => sum + getQty(pizza.id) * pizza.price, 0);
        cartTotal.innerHTML = `<span>Итого</span><span>${totalValue} ₽</span>`;
      }

      function setupTabs() {
        const buttons = document.querySelectorAll(".tab-button");
        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            buttons.forEach((item) => {
              item.classList.remove("active");
              item.setAttribute("aria-selected", "false");
            });
            button.classList.add("active");
            button.setAttribute("aria-selected", "true");

            const target = button.dataset.tab;
            document.querySelectorAll(".tab-panel").forEach((panel) => {
              panel.classList.toggle("active", panel.id === `tab-${target}`);
            });
          });
        });
      }

      clearCartButton.addEventListener("click", () => {
        Object.keys(cart).forEach((key) => delete cart[key]);
        saveCart();
        renderMenu();
        renderCart();
      });

      renderMenu();
      renderCart();
      setupTabs();

      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
    </script>
  </body>
</html>
